<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>MSTR/BTC Strategic Dashboard</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        body { font-family: 'Inter', sans-serif; background: #080808; color: #fff; padding: 20px; }
        .container { max-width: 1200px; margin: auto; background: #111; padding: 30px; border-radius: 15px; border: 1px solid #222; }
        .header { display: flex; justify-content: space-between; align-items: center; border-bottom: 1px solid #333; padding-bottom: 20px; }
        .chart-container { height: 550px; margin-top: 30px; }
        .caret-note { color: #ff4444; font-size: 0.8em; font-weight: bold; margin-top: 10px; }
        #sgt-time { color: #888; font-size: 0.9em; }
        table { width: 100%; border-collapse: collapse; margin-top: 30px; }
        th, td { padding: 12px; text-align: left; border-bottom: 1px solid #222; }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <div>
                <h1 style="margin:0; color:#00ff88;">Institutional Magnet Monitor</h1>
                <div class="caret-note">â–² RED TRIANGLE = Monthly Expiry (High Gravity)</div>
            </div>
            <div id="sgt-time">SGT: --</div>
        </div>

        <div class="chart-container">
            <canvas id="mainChart"></canvas>
        </div>

        <h3>30-Day Snapshot Log</h3>
        <table id="logTable">
            <thead><tr><th>Date</th><th>BTC Spot</th><th>MSTR Pain</th><th>Phase</th></tr></thead>
            <tbody id="logBody"></tbody>
        </table>
    </div>

<script>
    async function load() {
        const res = await fetch('./data/history.json');
        const market = await res.json();
        
        // SGT Time Setup
        const utc = new Date(market.last_update_utc);
        document.getElementById('sgt-time').innerText = `Updated (SGT): ${utc.toLocaleString('en-SG', {timeZone:'Asia/Singapore'})}`;

        render(market.data);
        renderTable();
    }

    function render(data) {
        const ctx = document.getElementById('mainChart').getContext('2d');
        new Chart(ctx, {
            type: 'line',
            data: {
                labels: data.map(d => d.date),
                datasets: [
                    {
                        label: 'MSTR Max Pain',
                        data: data.map(d => d.mstr_pain),
                        borderColor: '#00ff88',
                        yAxisID: 'yMSTR',
                        pointStyle: data.map(d => d.is_monthly ? 'triangle' : 'circle'),
                        pointRadius: data.map(d => d.is_monthly ? 12 : 5),
                        pointBackgroundColor: data.map(d => d.is_monthly ? 'red' : '#00ff88'),
                        tension: 0.3
                    },
                    {
                        label: 'BTC Max Pain',
                        data: data.map(d => d.btc_pain),
                        borderColor: '#3498db',
                        borderDash: [5, 5],
                        yAxisID: 'yBTC',
                        tension: 0.3
                    }
                ]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                scales: {
                    yMSTR: { type: 'linear', position: 'left', grid: { color: '#222' }, title: { display: true, text: 'MSTR ($)' } },
                    yBTC: { type: 'linear', position: 'right', grid: { drawOnChartArea: false }, title: { display: true, text: 'BTC ($)' } }
                }
            }
        });
    }

    async function renderTable() {
        const res = await fetch('./data/history_log.json');
        const logs = await res.json();
        document.getElementById('logBody').innerHTML = logs.reverse().map(l => `
            <tr>
                <td>${l.date}</td>
                <td>$${l.spot.toLocaleString()}</td>
                <td>$${l.mstr_pain}</td>
                <td>${l.confidence}</td>
            </tr>
        `).join('');
    }

    load();
</script>
</body>
</html>
